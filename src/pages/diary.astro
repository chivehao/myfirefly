---
import Icon from "@components/common/Icon.astro";
import I18nKey from "../i18n/i18nKey";
import {i18n} from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import {diaryConfig} from "@/content/config";
import {type DiaryItem} from "@/types/diary.ts";
import {getDiaries} from "@utils/content-utils.ts";
import {render} from "astro:content";
import Markdown from "@components/common/Markdown.astro";


// æ£€æŸ¥æ—¥è®°é¡µé¢æ˜¯å¦å¯ç”¨
if (!diaryConfig.enable) {
    return Astro.redirect("/404/");
}

// è·å–æ—¥è®°æ•°æ®
const diaries = await getDiaries();
const moments: DiaryItem[] = [];
for (const diary of diaries) {
    const { Content } = await render(diary);
    moments.push({
        id: diary.id,
        content: Content,
        date: diary.filePath as string,
    });
}


// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(dateString: string): string {
    // src/content/diaries/2026-02-06.md
    // è·å–æ—¥æœŸ
    dateString = dateString.substring(dateString.lastIndexOf('/') + 1, dateString.lastIndexOf('.'));

    var TG = 8;
    if (diaryConfig.utcTimeZone >= -12 && diaryConfig.utcTimeZone <= 12)
        TG = diaryConfig.utcTimeZone;
    const timeGap = TG;

    // const lang = siteConfig.lang;
    const now = new Date();
    const date = new Date(dateString);
    const diffInMinutes = Math.floor(
        (now.getTime() + timeGap * 60 * 60 * 1000 - date.getTime()) / (1000 * 60),
    );

    if (diffInMinutes < 60) {
        return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
    }
    if (diffInMinutes < 1440) {
        // 24å°æ—¶
        const hours = Math.floor(diffInMinutes / 60);
        return `${hours}${i18n(I18nKey.diaryHoursAgo)}`;
    }
    const days = Math.floor(diffInMinutes / 1440);
    return `${days}${i18n(I18nKey.diaryDaysAgo)}`;
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
            <div class="relative max-w-4xl w-full px-2 md:px-0">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div
                                class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70"
                        >
                            <Icon icon="material-symbols:group" class="text-[1.5rem]"/>

                        </div>
                        <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                            {i18n(I18nKey.diary)}
                        </h1>
                    </div>
                    <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed">
                        {i18n(I18nKey.diarySubtitle)}
                    </p>
                </div>

                <!-- çŸ­æ–‡åˆ—è¡¨ -->
                <div class="moments-timeline">
                    <div class="timeline-list space-y-4">
                        {moments.map((moment) => (
                                <div class="moment-item card-base-daily p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
                                    <Markdown class="markdown-content onload-animation">
                                        <moment.content/>
                                    </Markdown>

                                    <hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4"/>

                                    <div class="moment-footer flex justify-between items-center">
                                        <div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
                                            <i class="time-icon text-xs md:text-sm">ğŸ•</i>
                                            <time datetime={moment.date}>
                                                {formatTime(moment.date)}
                                            </time>
                                        </div>

                                    </div>
                                </div>
                        ))}
                    </div>
                </div>

                <!-- åº•éƒ¨æç¤º -->
                <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
                    {i18n(I18nKey.diaryTips)}
                </div>
            </div>
        </div>
    </div>
</MainGridLayout>

<style>
    .card-base-daily {
        @apply rounded-[var(--radius-large)] overflow-hidden bg-[var(--card-bg)];
        border: 1px solid var(--line-divider);
        transition: all 0.3s ease;
    }

    .moments-header {
        padding: 1rem;
        border-radius: 8px;
        //background: linear-gradient(135deg, var(--primary) 0%, var( var(--primary)) 100%);
        //color: white;
        position: relative;
        overflow: hidden;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }

    .moments-title {
        //color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .moments-subtitle {
        //color: rgba(255, 255, 255, 0.9);
    }

    .stat-number {
        //color: white;
    }

    .stat-label {
        //color: rgba(255, 255, 255, 0.8);
    }

    .image-item img {
        transition: transform 0.3s ease;
    }

    .image-item:hover img {
        transform: scale(1.05);
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
    }

    .action-btn:hover {
        color: var(--primary);
    }

    /* å“åº”å¼è®¾è®¡ */
    /* æ‰‹æœºç«¯ (å°äº640px) */
    @media (max-width: 640px) {
        .moments-header {
            padding: 0.75rem;
        }

        .header-content {
            flex-direction: column;
            text-align: center;
            gap: 0.75rem;
        }

        .diary-images {
            grid-template-columns: repeat(2, 1fr);
        }

        .moment-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }

    /* å¹³æ¿ç«–å± (641px - 900px) - ä¼˜åŒ–æ˜¾ç¤º */
    @media (min-width: 641px) and (max-width: 900px) {
        .moments-header {
            padding: 1.25rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .moment-item {
            padding: 1.5rem;
        }

        .diary-images {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            max-width: 500px;
        }

        .moment-text {
            font-size: 1rem;
            line-height: 1.7;
        }

        .moment-footer {
            margin-top: 1rem;
        }
    }

    /* å¹³æ¿æ¨ªå±å’Œæ¡Œé¢ç«¯ (å¤§äº900px) */
    @media (min-width: 901px) {
        .moments-header {
            padding: 1.5rem;
        }

        .moment-item {
            padding: 2rem;
        }

        .diary-images {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            max-width: 600px;
            gap: 1rem;
        }

        .moment-text {
            font-size: 1.1rem;
            line-height: 1.8;
        }
    }

    /* ä¼˜åŒ–å°å±å¹•æ˜¾ç¤º */
    @media (max-width: 480px) {
        .moment-item {
            border-radius: 8px;
        }

        .moments-header {
            border-radius: 6px;
        }
    }
</style>